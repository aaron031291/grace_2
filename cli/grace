#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Universal Grace Launcher - Works on ALL Operating Systems
One command to rule them all: grace
"""
import sys
import subprocess
import platform
import os
from pathlib import Path
import time

# Get the directory where this script is located
GRACE_ROOT = Path(__file__).parent.absolute()

def setup_working_directory():
    """Ensure we're in the Grace root directory"""
    print(f"üìÅ Grace root: {GRACE_ROOT}")
    
    # Change to Grace directory
    os.chdir(GRACE_ROOT)
    print(f"üìÇ Working directory: {os.getcwd()}")
    
    # Verify critical files exist
    critical_files = [
        "backend/grace.py",
        "backend/main.py",
        "RUN_GRACE.ps1"
    ]
    
    missing_files = []
    for file_path in critical_files:
        if not (GRACE_ROOT / file_path).exists():
            missing_files.append(file_path)
    
    if missing_files:
        print(f"‚ùå Missing files: {', '.join(missing_files)}")
        print(f"‚ùå Are you in the Grace directory? Current: {GRACE_ROOT}")
        return False
    
    print("‚úÖ All critical files found")
    return True

def find_log_files():
    """Find log files in various possible locations"""
    possible_log_paths = [
        GRACE_ROOT / "logs" / "backend.log",
        GRACE_ROOT / "logs" / "grace.log",
        GRACE_ROOT / "backend.log",
        GRACE_ROOT / "grace.log",
        GRACE_ROOT / "logs" / "ingestion.log",
        GRACE_ROOT / "logs" / "ingestion_visual.log"
    ]
    
    existing_logs = [path for path in possible_log_paths if path.exists()]
    return existing_logs

def tail_logs(lines=50):
    """Cross-platform log tailing with directory awareness"""
    log_files = find_log_files()
    
    if not log_files:
        print("‚ùå No log files found in:")
        print(f"   - {GRACE_ROOT}/logs/")
        print(f"   - {GRACE_ROOT}/")
        return
    
    # Use the most recent log file
    latest_log = max(log_files, key=lambda p: p.stat().st_mtime)
    
    print(f"üìú Tailing {latest_log.name} (last {lines} entries)")
    print(f"üìÅ Location: {latest_log}")
    print("=" * 80)
    
    try:
        with open(latest_log, 'r', encoding='utf-8', errors='ignore') as f:
            all_lines = f.readlines()
            tail_lines = all_lines[-lines:] if len(all_lines) > lines else all_lines
            
            for i, line in enumerate(tail_lines, 1):
                timestamp = ""
                if line.startswith('[') or line.startswith('20'):
                    timestamp = f"[{i:2d}] "
                else:
                    timestamp = f"[{i:2d}] "
                print(f"{timestamp}{line.rstrip()}")
                
    except Exception as e:
        print(f"‚ùå Error reading logs: {e}")

def tail_logs_live():
    """Live log streaming with directory awareness"""
    log_files = find_log_files()
    
    if not log_files:
        print("‚ùå No log files found")
        return
    
    # Use the most recent log file
    latest_log = max(log_files, key=lambda p: p.stat().st_mtime)
    
    print(f"üì° Live streaming: {latest_log.name}")
    print(f"üìÅ Location: {latest_log}")
    print("üì° Press Ctrl+C to stop...")
    print("=" * 80)
    
    try:
        with open(latest_log, 'r', encoding='utf-8', errors='ignore') as f:
            # Go to end of file
            f.seek(0, 2)
            
            while True:
                line = f.readline()
                if line:
                    print(line.rstrip())
                else:
                    time.sleep(0.1)
                    
    except KeyboardInterrupt:
        print("\n‚úÖ Log streaming stopped")
    except Exception as e:
        print(f"‚ùå Error streaming logs: {e}")

def get_launcher_command(os_type, args):
    """Get appropriate launcher command for OS with proper paths"""
    if os_type == "windows":
        # Use full path to PowerShell script
        ps_script = GRACE_ROOT / "RUN_GRACE.ps1"
        return [
            "powershell", 
            "-ExecutionPolicy", "Bypass",
            "-File", str(ps_script)
        ] + args
    else:
        # Use full path to Python script
        py_script = GRACE_ROOT / "backend" / "grace.py"
        return [sys.executable, str(py_script)] + args

def show_status():
    """Show Grace status with directory info"""
    print(f"üìÅ Grace Directory: {GRACE_ROOT}")
    print(f"üìÇ Working Directory: {os.getcwd()}")
    print(f"üêç Python: {sys.executable}")
    print(f"üñ•Ô∏è  OS: {platform.system()} {platform.release()}")
    
    # Check if Grace is running (simple check)
    try:
        import requests
        response = requests.get("http://localhost:8000/health", timeout=2)
        if response.status_code == 200:
            print("‚úÖ Grace Backend: Running (port 8000)")
        else:
            print("‚ùå Grace Backend: Not responding")
    except:
        print("‚ùå Grace Backend: Not running")
    
    # Show log files
    log_files = find_log_files()
    if log_files:
        print(f"üìú Log Files Found: {len(log_files)}")
        for log_file in log_files:
            size = log_file.stat().st_size
            print(f"   - {log_file.name} ({size:,} bytes)")
    else:
        print("üìú No log files found")

def main():
    """Universal Grace launcher with directory awareness"""
    try:
        print("ü§ñ Grace AI - Universal Launcher")
        print(f"üìç Script location: {Path(__file__).absolute()}")
        
        # Setup working directory first
        if not setup_working_directory():
            sys.exit(1)
        
        # Parse arguments
        args = sys.argv[1:]
        
        # Handle help
        if "--help" in args or "-h" in args:
            show_help()
            return
        
        # Handle status
        if "--status" in args:
            show_status()
            return
        
        # Handle logs
        if "--logs" in args:
            idx = args.index("--logs")
            lines = 50
            if idx + 1 < len(args) and args[idx + 1].isdigit():
                lines = int(args[idx + 1])
            tail_logs(lines)
            return
        
        # Handle live tail
        if "--tail" in args:
            tail_logs_live()
            return
        
        # Detect OS
        os_type, shell_type = detect_os_details()
        print(f"üîç Detected: {os_type.title()}")
        
        # Setup OS environment
        setup_os_environment(os_type)
        
        # Get launcher command
        launcher_cmd = get_launcher_command(os_type, args)
        
        print(f"üöÄ Starting Grace...")
        print(f"üìÅ Command: {' '.join(launcher_cmd)}")
        
        # Execute launcher
        result = subprocess.run(launcher_cmd)
        sys.exit(result.returncode)
        
    except KeyboardInterrupt:
        print("\n‚úÖ Grace stopped")
        sys.exit(0)
    except Exception as e:
        print(f"‚ùå Error: {e}")
        print(f"üìÅ Current directory: {os.getcwd()}")
        print(f"üìÅ Grace root: {GRACE_ROOT}")
        sys.exit(1)

if __name__ == "__main__":
    main()





