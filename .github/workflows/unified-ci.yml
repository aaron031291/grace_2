name: Unified CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20.19.0'
  OFFLINE_MODE: 'true'
  DRY_RUN: 'true'
  CI: 'true'
  DISABLE_LEARNING_JOBS: 'true'
  SEARCH_PROVIDER: 'mock'

jobs:
  # Phase 1: Fast checks (< 2 minutes)
  fast-checks:
    name: Fast Checks
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install minimal dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml
      
      - name: Check VERSION consistency
        run: |
          python -c "
          import re
          from pathlib import Path
          
          # Read VERSION file
          version_file = Path('VERSION').read_text().strip()
          
          # Check pyproject.toml
          pyproject = Path('pyproject.toml').read_text()
          pyproject_match = re.search(r'version\s*=\s*\"([^\"]+)\"', pyproject)
          pyproject_version = pyproject_match.group(1) if pyproject_match else 'NOT FOUND'
          
          print(f'VERSION file: {version_file}')
          print(f'pyproject.toml: {pyproject_version}')
          
          if version_file != pyproject_version:
              print('ERROR: Version mismatch!')
              exit(1)
          print('✓ Versions match')
          "
      
      - name: Verify directory structure
        run: |
          python -c "
          from pathlib import Path
          
          required_dirs = ['backend', 'frontend', 'tests', 'scripts', 'alembic']
          required_files = ['alembic.ini', 'pyproject.toml', 'VERSION', 'README.md']
          
          missing = []
          for d in required_dirs:
              if not Path(d).exists():
                  missing.append(f'Directory: {d}')
          
          for f in required_files:
              if not Path(f).exists():
                  missing.append(f'File: {f}')
          
          if missing:
              print('ERROR: Missing required items:')
              for item in missing:
                  print(f'  - {item}')
              exit(1)
          
          print('✓ All required directories and files exist')
          "
  
  # Phase 2: Backend validation (< 5 minutes)
  backend-validation:
    name: Backend Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: fast-checks
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          
          # Install from all requirements files
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f txt/requirements.txt ]; then pip install -r txt/requirements.txt; fi
          if [ -f backend/requirements.txt ]; then pip install -r backend/requirements.txt; fi
          
          # Install test dependencies
          pip install pytest pytest-asyncio ruff
      
      - name: Test unified path system
        run: |
          python backend/core/paths.py
      
      - name: Run import tests
        env:
          OFFLINE_MODE: 'true'
        run: |
          python scripts/test_imports.py
      
      - name: Run boot probe
        env:
          OFFLINE_MODE: 'true'
          DRY_RUN: 'true'
          GRACE_PORT: '8000'
        run: |
          python scripts/test_boot_probe.py
      
      - name: Run startup diagnostics
        env:
          OFFLINE_MODE: 'true'
        run: |
          python scripts/diagnose_startup.py || echo "Some diagnostics failed (non-critical)"
      
      - name: Ruff linting (non-blocking)
        run: |
          ruff check backend --output-format=github || echo "Linting issues found (non-blocking)"
        continue-on-error: true
      
      - name: Run pytest
        run: |
          # Run only core unit tests (conftest.py excludes integration tests)
          pytest tests/test_guardian_playbooks.py tests/test_phase2_rag.py tests/test_failure_mode_01.py tests/test_failure_mode_02.py -v --tb=short --junitxml=test-results/pytest.xml
        continue-on-error: false
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-results
          path: test-results/pytest.xml
  
  # Phase 3: Alembic validation
  alembic-validation:
    name: Alembic Migrations
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: fast-checks
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for migration chain validation
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Alembic and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install alembic sqlalchemy
          # Install backend dependencies for model imports
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f txt/requirements.txt ]; then pip install -r txt/requirements.txt; fi
      
      - name: Check migration chain integrity
        run: |
          python -c "
          import re
          from pathlib import Path
          
          versions_dir = Path('alembic/versions')
          if not versions_dir.exists():
              print('⚠️  No migrations directory')
              exit(0)
          
          migration_files = list(versions_dir.glob('*.py'))
          if not migration_files:
              print('⚠️  No migration files')
              exit(0)
          
          # Build revision map
          revisions = {}
          for mf in migration_files:
              content = mf.read_text()
              rev_match = re.search(r'revision = [\\'\\\"]([^\\'\\\"]+)[\\'\\\"]', content)
              down_match = re.search(r'down_revision = [\\'\\\"]([^\\'\\\"]+)[\\'\\\"]', content)
              
              if rev_match and down_match:
                  revision = rev_match.group(1)
                  down_revision = down_match.group(1)
                  revisions[revision] = down_revision
          
          # Find heads
          all_revisions = set(revisions.keys())
          down_revisions = set(revisions.values()) - {'None'}
          heads = all_revisions - down_revisions
          
          if len(heads) > 1:
              print(f'❌ Multiple heads detected: {heads}')
              exit(1)
          
          print(f'✓ Migration chain is linear ({len(revisions)} migrations)')
          "
      
      - name: Test Alembic upgrade (dry-run)
        run: |
          # Generate SQL for upgrade to verify it works
          alembic upgrade head --sql > /dev/null 2>&1 || echo "⚠️  Alembic upgrade --sql failed (may need DB setup)"
  
  # Phase 4: Frontend validation (parallel with backend)
  frontend-validation:
    name: Frontend Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: fast-checks
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Lint (non-blocking)
        run: |
          cd frontend
          npm run lint || echo "Linting issues found (non-blocking)"
        continue-on-error: true
      
      - name: Type check (non-blocking)
        run: |
          cd frontend
          npm run type-check || echo "Type errors found (non-blocking)"
        continue-on-error: true
      
      - name: Build frontend
        run: |
          cd frontend
          npm run build
  
  # Phase 5: Integration tests (after all validation passes)
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [backend-validation, frontend-validation, alembic-validation]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f txt/requirements.txt ]; then pip install -r txt/requirements.txt; fi
          pip install uvicorn httpx
      
      - name: Run migrations
        run: |
          alembic upgrade head || echo "No migrations or migration failed"
        continue-on-error: true
      
      - name: Start backend server
        run: |
          uvicorn backend.main:app --host 127.0.0.1 --port 8000 &
          sleep 15
        env:
          OFFLINE_MODE: 'false'
      
      - name: Health check
        run: |
          curl -f http://localhost:8000/health || exit 1
      
      - name: Test key endpoints
        run: |
          # Vector health
          curl -f http://localhost:8000/api/vectors/health || echo "Vector API unavailable"
          
          # Guardian health
          curl -f http://localhost:8000/api/guardian/health || echo "Guardian API unavailable"
        continue-on-error: true
  
  # Phase 6: Summary and status
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [fast-checks, backend-validation, frontend-validation, alembic-validation, integration-tests]
    if: always()
    
    steps:
      - name: Check job statuses
        run: |
          echo "=========================================="
          echo "CI Pipeline Summary"
          echo "=========================================="
          echo "Fast Checks: ${{ needs.fast-checks.result }}"
          echo "Backend Validation: ${{ needs.backend-validation.result }}"
          echo "Frontend Validation: ${{ needs.frontend-validation.result }}"
          echo "Alembic Validation: ${{ needs.alembic-validation.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          echo "=========================================="
          
          # Fail if any required job failed
          if [ "${{ needs.fast-checks.result }}" != "success" ] || \
             [ "${{ needs.backend-validation.result }}" != "success" ] || \
             [ "${{ needs.frontend-validation.result }}" != "success" ]; then
            echo "❌ CI Pipeline FAILED"
            exit 1
          fi
          
          echo "✓ CI Pipeline PASSED"
