name: Secrets Capture and Consent Flow
version: "1.0"
domain: security
risk_level: high
description: |
  Capture external API credentials securely and enforce
  user consent before Grace uses them.
  
  Flow:
  1. User provides credential → Store encrypted in vault
  2. Grace requests access → Trigger consent prompt
  3. User approves/denies → Governance check
  4. Grace uses credential → Audit log
  5. Monitor usage → Auto-rotate on schedule

triggers:
  - event: secrets.store.requested
  - event: secrets.access.requested
  - manual: true

steps:
  - name: validate_secret_type
    description: Validate secret type and determine risk level
    action: classify_secret
    params:
      types:
        api_key: medium
        password: high
        oauth_token: high
        ssh_key: critical
        certificate: critical
    output: risk_level
  
  - name: encrypt_and_store
    description: Encrypt credential and store in vault
    action: call_service
    params:
      service: secrets_vault
      method: store_secret
      encryption: fernet
    verification:
      - encrypted_value != plain_value
      - encryption_key_id is not null
  
  - name: request_user_consent
    description: Request user consent before first use
    action: send_ui_prompt
    params:
      topic: secrets.consent.request
      timeout_seconds: 300
      prompt: "Grace wants to use your {service} credentials to {action}. Allow?"
    wait_for: secrets.consent.response
  
  - name: check_governance
    description: Governance approval for high/critical risk
    conditions:
      - risk_level in [high, critical]
    action: call_service
    params:
      service: governance_engine
      method: check
      action: secrets.{requested_action}
    
  - name: log_access_attempt
    description: Audit log all access attempts
    action: write_audit_log
    params:
      table: secret_access_log
      fields:
        - secret_key
        - accessor
        - access_granted
        - timestamp
        - ip_address
  
  - name: monitor_usage_patterns
    description: Detect unusual usage patterns
    action: analyze_logs
    params:
      lookback_hours: 24
      alert_conditions:
        - access_count > 100  # Excessive usage
        - distinct_accessors > 5  # Too many users
        - failed_attempts > 3  # Brute force?
  
  - name: schedule_rotation
    description: Schedule automatic credential rotation
    conditions:
      - secret_type in [api_key, oauth_token]
      - rotation_days is not null
    action: create_scheduled_task
    params:
      schedule: "0 2 * * 0"  # Weekly Sunday 2 AM UTC
      task_type: rotate_secret

outcomes:
  consent_granted:
    - decrypt_secret
    - provide_to_requester
    - log_success
  
  consent_denied:
    - log_denial
    - notify_requester
    - update_metrics
  
  governance_denied:
    - log_governance_block
    - alert_security_team
    - require_manual_review

rollback:
  - revoke_consent
  - invalidate_cached_credential
  - notify_user

metadata:
  owner: security_team
  compliance: SOC2, GDPR
  audit_required: true
  documentation: docs/LAYER_2_3_INTEGRATION_COMPLETE.md
